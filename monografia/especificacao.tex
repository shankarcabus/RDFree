\chapter{Especificação, Desenvolvimento e Validação do iSoundFx}
\label{cap:especificacao}
% -------------------------------------- CAPÍTULO ISOUNDFX -------------------------------------------
A demanda por aplicações para dispositivos móveis tem crescido nos últimos tempos. E, para atendê-la é necessário que o processo de desenvolvimento dos aplicativos não exceda o \textit{time to market}\footnote{\textit{Time to market é o tempo de lançamento de um produto no mercado.}}. Porém, é comum que ocorram atrasos neste processo, principalmente quando as aplicações envolvem áreas de conhecimento fora da esfera da equipe de desenvolvimento.
 Nesse contexto o reuso de código surge como uma alternativa para otimizar a construção desses aplicativos, evitando a utilização de trechos de códigos repetidos e diminuindo o tempo gasto com rotinas já criadas por outros programadores.

No domínio de aplicações musicais para a plataforma iOS, o reuso de código ainda é algo pouco utilizado devido a carências de fontes. Segundo a \citeonline{apple2012a}, o \textit{framework Audio Units} possibilita que os desenvolvedores utilizem funções que facilitam a manipulação de áudio na plataforma, mas também salienta que por ter um grau abstração baixo, a quantidade de código necessário para realizar operações triviais ainda é alto.

Portanto, esse trabalho tem como objetivo desenvolver uma biblioteca de efeitos sonoros \textit{Open Source} para a plataforma iOS com o intuito de diminuir os esforços dos desenvolvedores e agilizar o tempo de programação. Essa biblioteca foi denominada iSoundFX junção dos nomes (iOS + \textit{Sound} + \textit{Effects}).

Com o uso dessa biblioteca os programadores podem desenvolver aplicativos que auxiliam os músicos na composição musical, jogos que envolvam o uso de efeitos sonoros, além de outros aplicativos na categoria musical ou de entretenimento.

Para que isso seja possível, o usuário terá que utilizar o microfone do dispositivo ou conectar um instrumento musical a um adaptador que seja compatível com a interface do mesmo. Feito isto, o áudio capturado é processado pelos algoritmos de efeitos do iSoundFX, que estará presente na aplicação, e em seguida executado na \textit{interface} de \textit{hardware} responsável por transmitir o áudio a um fone de ouvido, ou caixas de som plugadas no aparelho.

A Figura \ref{fig:funcionamento} demonstra o percurso que o fluxo de áudio segue do momento da captura até ser executado nos fones de ouvido: o som é produzido pela guitarra, passa por uma adaptador que conecta a guitarra a um dispositivo iOS, representado na imagem como  fluxo de entrada. Após o processamento dos efeitos o som passa pelo adaptador e é escutado pelos fones de ouvido, simbolizado na figura como fluxo de saída.

\begin{figure}[H]
\center
\includegraphics[scale=1.0]{funcionamento.png}
\caption{Exemplo de funcionamento do ISoundFX}
\label{fig:funcionamento}
\end{figure}

Nas próximas seções serão apresentados exemplos de aplicações de efeitos sonoros na loja \textit{Apple Store}, e duas aplicações \textit{Open Source} do domínio musical relevantes no desenvolvimento do trabalho. A partir das informações obtidas dos aplicativos analisados foi possível conduzir a elaboração dos requisitos funcionais e não funcionais utilizados na concepção deste trabalho.

Ainda neste capítulo serão abordados o diagrama de arquitetura do projeto, o diagrama de classes e os principais métodos da biblioteca. Logo após será demonstrado como foram desenvolvidos os efeitos sonoros. Para finalizar serão apresentados a aplicação de exemplo utilizando o iSoundFX e os resultados alcançados.

% --------------------------- SEÇÃO APLICATIVOS DA APPLE STORE --------------------------------------

\section{Aplicativos Disponíveis na \textit{Apple Store}}
\label{sec:aplicativoapple}

Na \textit{Apple Store} as aplicações são categorizadas de acordo com o seu grau de afinidade. As categorias podem ser: Jogos, Educação, Entreternimento, Livros, Músicas e outras. As funcionalidades pertinentes a especificação do iSoundFX foram obtidas através da análise, na categoria musical, dos aplicativos que utilizam recursos de efeitos de áudio. Na Figura \ref{fig:aplicacoes} podem ser observados alguns dos efeitos vistos em nas aplicações \textit{Amplitube} e \textit{GarageBand}.

\begin{figure}[H]
\center
\includegraphics[scale=0.4]{aplicacoes.png}
\caption{Aplicações \textit{Amplitube} e \textit{GarageBand}}
\label{fig:aplicacoes}
\end{figure}

A partir do estudo das cinco aplicações mais populares foi possível levantar informações tais como: os efeitos utilizados, à simultaneidade (quantidade de efeitos em conjunto) e o valor cobrado por aplicativo, conforme pode ser visto na Tabela \ref{tab:aplicacoes}. Pode-se observar que alguns efeitos vistos nesta tabela não foram apresentados na seção \ref{sec:efeitos}, pois estes não tiveram relevância no desenvolvimento deste trabalho.

Foram escolhidos os seguintes efeitos para fazer parte do iSoundFX: \textit{Distortion}, \textit{Overdrive}, \textit{Fuzz}, \textit{Tremolo}, \textit{Delay} e \textit{Pitch Shifter}. Constatou-se que estes efeitos fazem parte da maioria dos aplicativos avaliados.
 
Ainda com base nos dados da Tabela \ref{tab:aplicacoes}, observou-se também a quantidade máxima de efeitos que podem ser usados simultaneamente que, na média, obteve-se o valor 4,4. Acerca desse dado, foi definido que o iSoundFX deve suportar até quatro efeitos simultâneos.

Outro ponto observado nesta análise é que em quase todas as aplicações vistas, a ordem dos efeitos pode ser alterada, assim como a ligação em série dos pedais, vistos na seção \ref{sec:efeitos}. Este recurso também foi incluído na biblioteca. 

\begin{table}[H] % [htb]-> here, top, bottom
   \centering   % tabela centralizada
   \setlength{\arrayrulewidth}{2\arrayrulewidth}  % espessura da  linha
   \setlength{\belowcaptionskip}{10pt}  % espaço entre caption e tabela
   \caption[Principais efeitos das aplicações pagas da \textit{Apple Store}]{Principais efeitos das aplicações pagas da \textit{Apple Store}}
   \label{tab:aplicacoes}
   \begin{adjustwidth}{-1cm}{-1cm}  
   \begin{center}
   \begin{tabular}{|c|c|c|c|c|c|c|} % c=center, l=left, r=right 
      \hline
        &\textit{GarageBand}&\textit{AmpKit}&\textit{AmpliTube}&\textit{PocketAmp}&\textit{Stompbox}&Total\\\hline
		\textit{Chorus}&X&X&X&X&X&5\\\hline
		\textit{Equalizer}&X&X&X&X&X&5\\\hline
		\textit{Flanger}&X&X&X&X&X&5\\\hline
		\textit{Delay / Echo}&X&X&X&X&X&5\\\hline		
		\textit{Overdrive}&X&X&X&X&&4\\\hline
		\textit{Distortion}&X&X&&X&X&4\\\hline
		\textit{Fuzz}&X&X&X&&X&4\\\hline
		\textit{Noise Filter}&&X&X&X&X&4\\\hline
		\textit{Tremolo / Vibrato}&X&X&&X&X&4\\\hline
		\textit{Reverb}&X&X&&X&X&4\\\hline		
		\textit{Phaser}&&X&X&&X&3\\\hline
		\textit{Compressor}&X&X&&&X&3\\\hline
		\textit{Wah}&&X&X&&&2\\\hline
		\textit{Envelope Filter}&&X&X&&&2\\\hline
		\textit{Octave}&&X&X&&&2\\\hline		
		\textit{Pitch Shifter}&&&&&X&1\\\hline
		Efeitos Simultâneos&4&6&3&3&6&4,4\\\hline
		Preço&\$4,99&\$19,99&\$19,99&\$4,99&\$19,99&\$13,99
      \\\hline
    \end{tabular}
    \end{center}
    \end{adjustwidth}
\end{table}

% --------------------------- SEÇÃO APLICAÇÕES SKYPEFX E AUDIOGRAPH --------------------------------------

\section{Aplicações \textit{SkypeFX} e \textit{audioGraph}}
\label{sec:aplicacoesopen}

A análise das aplicações \textit{Open Source} foi fundamental no processo de desenvolvimento dos efeitos, levantamento dos requisitos, arquitetura do projeto e diagrama de classes, são elas: o \textit{SkypeFX} e o \textit{audioGraph}. Esses programas foram escolhidos, principalmente, devido aos recursos encontrados e pela falta de opções dada a quantidade limitada de \textit{softwares} nesta área. 

A aplicação \textit{SkypeFX} é um projeto em \textit{C\#} que permite o uso de efeitos sonoros  em tempo real para uma conversação em chat do \textit{Skype}\footnote{\textit{Skype} é um programa para conversação pela \textit{internet}.} \cite{heath}. Essa aplicação permitiu que o efeito de \textit{Tremulo} fosse adicionado no iSoundFX realizando as alterações necessárias. A tela principal do programa pode ser visualizada na Figura \ref{fig:skypefx}.

\begin{figure}[H]
\center
\includegraphics[scale=0.65]{skypefx.png}
\caption{Programa \textit{SkypeFX}}
\label{fig:skypefx}
\end{figure}

O \textit{audioGraph} é um aplicativo de exemplo de utilização dos recursos de áudio na plataforma iOS \cite{zicarelli}. Entre outros recursos, essa aplicação inclui o uso de efeitos sonoros em tempo real e a captura e execução simultânea de áudio, na qual foram objetos de estudo para o processo de desenvolvimento do iSoundFX. O aplicativo pode ser visto na Figura \ref{fig:audiograph}.

\begin{figure}[H]
\center
\includegraphics[scale=0.55]{audiograph.png}
\caption{Aplicativo \textit{audioGraph}}
\label{fig:audiograph}
\end{figure}

Uma das falhas encontradas no \textit{SkypeFX} foi o acoplamento dos efeitos com a interface de usuário, com isso muitas vezes trechos de código se misturavam com as telas da aplicação, diminuindo a legibilidade do código. Outro ponto considerado negativo foi a utilização de herança de classe em pontos não relevantes, como por exemplo, classe de funções matemáticas sendo herdadas por classes de efeitos musicais.

No portal onde está hospedado o projeto \textit{SkypeFX}, não foram encontradas documentações acerca da arquitetura, requisitos ou diagrama de classes, dificultando o processo de identificação do funcionamento dos efeitos e da aplicação como um todo.

Apesar da documentação, o que facilitou bastante o entendimento do seu funcionamento, a aplicação \textit{audioGraph} falhou por criar um acoplamento de código através da junção das funcionalidades em um único arquivo, ocasionando um desconforto visual na leitura do código.

Fazendo um comparativo entre este trabalho e as aplicações \textit{SkypeFX} e \textit{audioGraph} obteve-se a tabela \ref{tab:comparativo}. Ressaltando que acoplamento de código e interface são aspectos negativos.

\begin{table}[H] % [htb]-> here, top, bottom
   \centering   % tabela centralizada
   \setlength{\arrayrulewidth}{2\arrayrulewidth}  % espessura da  linha
   \setlength{\belowcaptionskip}{10pt}  % espaço entre caption e tabela
   \caption{Comparação entre as aplicações \textit{SkypeFX}, \textit{audioGraph} e a biblioteca iSoundFX}
   \label{tab:comparativo}
   \begin{adjustwidth}{2cm}{2cm}  
   \begin{center}
   \begin{tabular}{|c|c|c|c|} % c=center, l=left, r=right 
      \hline
		Recurso&\textit{SkypeFX}&\textit{audioGraph}&iSoundFX\\\hline
		\textit{Chorus}&X&&\\\hline
		\textit{Compressor}&X&&\\\hline
		\textit{Delay}&X&X&X\\\hline		
		\textit{Distortion}&&&X\\\hline
		\textit{Equalizer}&X&&\\\hline
		\textit{Flanger}&X&&\\\hline		
		\textit{Fuzz}&&&X\\\hline
		\textit{Overdrive}&&&X\\\hline
		\textit{Pitch}&X&X&X\\\hline
		\textit{Ringer}&&X&\\\hline			
		\textit{Tremolo}&X&&X\\\hline		
		Efeitos Simultâneos&X&&X\\\hline		
		Código \textit{Open Source}&X&X&X\\\hline
		Documentação&&X&X\\\hline
		Acoplamento de código&&X&\\\hline		         
		Acoplamento de interface&X&&
      \\\hline
    \end{tabular}
    \end{center}
    \end{adjustwidth}      
\end{table}

% -------------------------------------- PROJETO ARQUITETURAL E CLASSES RELEVANTES ------------------------------------------------

\section{Projeto Arquitetural e Classes Relevantes}

A análise das aplicações do mercado e \textit{Open Source} foram importantes no processo de levantamento dos requisitos do ISoundFX. Para o desenvolvimento do projeto foram definidos os requisitos funcionais (RF) e não funcionais (RNF), que podem ser vistos na tabela \ref{tab:requisitos}.

\begin{table}[H] % [htb]-> here, top, bottom
   \centering   % tabela centralizada
   \setlength{\arrayrulewidth}{2\arrayrulewidth}  % espessura da  linha
   \setlength{\belowcaptionskip}{10pt}  % espaço entre caption e tabela
   \caption[Requisitos do iSoundFX]{Requisitos do iSoundFX}
   \label{tab:requisitos}
   \begin{tabular}{|l| p{13cm}|} % c=center, l=left, r=right 
      \hline
		Requisito&Descrição\\\hline
        RF1&A biblioteca deve conter os efeitos de \textit{Distortion}, \textit{Overdrive}, \textit{Fuzz}, \textit{Tremolo}, \textit{Delay} e \textit{Pitch Shifter}\\\hline
		RF2&Cada efeito deve ter os parâmetros de funcionamento ajustados individualmente\\\hline
		RF3&A biblioteca deve dar suporte ao funcionamento de até quatro efeitos simultâneos\\\hline
		RF4&Os efeitos, quando em conjunto, devem suportar a mudança da ordem de execução\\\hline
		RF5&Os efeitos podem ser desativados, removidos ou adicionados à cadeia de efeitos\\\hline
		RF6&Um módulo de captura e execução de áudio também deve ser incluso na biblioteca\\\hline
		RNF1&A biblioteca deve funcionar em aparelhos com o Sistema iOS com versão 5.1 ou superior\\\hline
		RNF2&O tempo de execução dos efeitos devem ser em tempo real\\\hline
		RNF3&A arquitetura da biblioteca deve dar suporte à inclusão de novos efeitos
      \\\hline
    \end{tabular}
\end{table}

O projeto arquitetural deste trabalho é ilustrado pela Figura \ref{fig:arquitetura}: na camada (a) está a aplicação hospedeira, pelo fato de hospedar a biblioteca, que realizará os ajustes dos efeitos individualmente de acordo com o requisito RF2. A aplicação também controlará quando será iniciado o fluxo de captura de áudio e quando será interrompido.

\begin{figure}[H]
\center
\fbox{\includegraphics[scale=0.6]{arquitetura.png}}
\caption[Arquitetura do iSoundFX]{Arquitetura do iSoundFX: (a) Aplicação Hospedeira; (b) Biblioteca iSoundFX; (c) API Nativa.}
\label{fig:arquitetura}
\end{figure}

Na camada inferior (c) está o \textit{Audio Unit framework}, responsável por gerenciar os \textit{Drivers}, \textit{Hardware} de áudio no iOS entre outras funcionalidades. A principal função desta camada é prover as amostras de áudio capturadas para a biblioteca e executar essas mesmas amostras após o processamento de áudio contemplando o requisito RF6.

Por último está a camada intermediária indicada por (b) que é a biblioteca iSoundFX, podendo ser subdividida em três módulos:

\begin{itemize}

\item Configurações dos efeitos --- é por este módulo que a aplicação realizará os ajustes do sistema bem como adicionar, remover, desativar, ordenar os efeitos, contemplando os requisitos RF2, RF4 e RF5;
\item Captura e Execução de Áudio --- é por esse pacote que a biblioteca irá capturar as amostras de áudio, passar essas amostras para a cadeia de efeitos para ser processado e depois retornará a ela para ser executado conforme o requisito RF6; 
\item Cadeia de efeitos --- os efeitos criados funcionarão em série, compartilhando as amostras de áudio entre si de forma unidirecional. Apesar do requisito RF3 indicar que apenas quatro efeitos serão executados simultaneamente, o projeto também poderá dar suporte a N efeitos.

\end{itemize}

Após a definição dos requisitos e do projeto arquitetural foi possível obter um diagrama de classes que pudessem contemplar as funções e rotinas da biblioteca. O estudo dos códigos fonte dos projetos \textit{Open Source} auxiliou na identificação das principais classes envolvidas no projeto.

A fim de reduzir os impactos na criação e adição de novos efeitos no iSoundFX optou-se por utilizar o padrão de projeto chamado \textit{Strategy}. Esse padrão permitiu que os efeitos fossem adicionados ao projeto reduzindo o esforço do desenvolvedor.

A partir do diagrama de classes da Figura \ref{fig:diagramaclasses} serão apresentadas as principais classes envolvidas na elaboração deste trabalho.

\begin{figure}[H]
\center
\fbox{\includegraphics[scale=0.45]{diagramaclasses.png}}
\caption{Diagrama de Classes do iSoundFX}
\label{fig:diagramaclasses}
\end{figure}

\textbf{\textit{Effect}} --- É a classe abstrata comum a todos os efeitos. Ela tem como principais atributos a quantidade de amostras (\textit{sampleRate}), o estado de ativação e os parâmetros do efeito. Seus principais métodos são: 
\begin{itemize}

\item \textit{onSample}: que receberá as amostras de áudio; 
\item \textit{onInit}: será chamado quando o efeito for iniciado;
\item \textit{onConfigurationChanged}: será chamado sempre que houver uma modificação nos parâmetros dos efeitos;

\end{itemize}

\textbf{\textit{EffectImplement}} --- É a implementação da classe abstrata \textit{Effect} (o nome da classe foi usado apenas ilustrar). Nessa classe apenas os métodos abstratos deverão ser sobescritos. As alocações de memória e inicialização de atributos do efeito, bem como a inserção dos parâmetros deverão ser realizados no método \textit{onInit}, e não no método nativo \textit{init}, o qual não pode ser sobescrito. O método \textit{onSample} será chamado sempre que houver novas amostras para serem processadas do áudio, recebendo por parâmetro a quantidade de amostras, \textit{numberFrames}, e os dados de áudio esquerdo e direito \textit{sampleBufferLeft} e \textit{sampleBufferRight}.

\textbf{\textit{Slider}} --- Responsável por armazenar as configurações dos efeitos bem como o valor máximo, mínimo e corrente: \textit{maximum}, \textit{minimum} e \textit{current} respectivamente). Os métodos são apenas de \textit{get} e \textit{set}.

\textbf{\textit{NativeAudio}} --- Essa é a classe que fará as configurações e inicialização do \textit{Audio Units} para a captura e execução simultânea das amostras de áudio. Uma referência da cadeia de efeitos será passada para ela com o intuito de serem processados, nesse caso o \textit{Strategy} proporcionou que não fosse necessário realizar modificações nessa classe ao incluir novos efeitos ao projeto, já que o único método utilizado por ela é o abstrato.

\textbf{\textit{ISoundFX}} --- É a classe de acesso à biblioteca pela aplicação. Através dela será possível manipular as principais funções da biblioteca, como configurar, adicionar, remover, desativar e alterar a ordem dos efeitos. Também será possível controlar quando será iniciado e parado o processo de captura de áudio. Os principais métodos de utilização dela podem ser vistos na tabela \ref{tab:principaismetodos}. 

A linguagem utilizada no projeto, a \textit{Objective-C}, possui algumas limitações em relação às outras linguagens de paradigma de Orientação a Objetos (OO), portanto algumas modificações foram realizadas para adaptá-la a necessidade do projeto.

Como o conceito de métodos abstrato não existem para essa linguagem, optou-se por solucionar o problema lançando uma exceção em tempo de execução caso o método não seja sobrescrito. Foi o caso dos métodos abstratos da classe \textit{Effect} exemplificados no Algoritmo \ref{lst:adaptacao}.

A falta de métodos do tipo \textit{final}, ou seja, métodos que não podem ser sobescritos pelas classes filhas foi uma limitação que não teve uma alternativa viável. Se o programador quiser sobrescrever os métodos ele não será impedido, mas fazendo isso ele comprometerá o funcionamento da classe. É o caso do método \textit{init} na classe \textit{EffectImplement}.

\begin{table}[H] % [htb]-> here, top, bottom
   \centering   % tabela centralizada
   \setlength{\arrayrulewidth}{2\arrayrulewidth}  % espessura da  linha
   \setlength{\belowcaptionskip}{10pt}  % espaço entre caption e tabela
   \caption[Principais Métodos do iSoundFX]{Principais Métodos do iSoundFX}
   \label{tab:principaismetodos}
   \begin{tabular}{|l|l|l|} % c=center, l=left, r=right 
      \hline
		Método&Descrição&Tipo de retorno\\\hline
        \textit{startAudioCapture}&Inicia a captura de áudio&\textit{void}\\\hline
		\textit{stopAudioCapture}&Para a captura de áudio&\textit{void}\\\hline
		\textit{addEffect}&Adiciona o efeito na cadeia&\textit{void}\\\hline
		\textit{removeEffect}&Remove o efeito na cadeia&\textit{void}\\\hline
		\textit{exchangeEffectAtIndex}&Troca a ordem do efeito na cadeia&\textit{void}\\\hline			
		\textit{enableEffect}&Habilita o efeito&\textit{void}\\\hline
		\textit{changeEffect}&Configura os parâmetros do efeito&\textit{void}\\\hline		
		\textit{count}&Obtém a quantidade de efeitos na cadeia&\textit{int}\\\hline				
		\textit{isEffectEnabled}&Verifica se o efeito está habilitado&\textit{bool}\\\hline
		\textit{getEffectMaxValue}&Obtém o valor máximo do parâmetro do efeito&\textit{float}\\\hline
		\textit{getEffectMinValue}&Obtém o valor mínimo do parâmetro do efeito&\textit{float}\\\hline
		\textit{getEffectValue}&Obtém o valor atual do parâmetro do efeito&\textit{float}		
      \\\hline
    \end{tabular}
\end{table}

\begin{lstlisting}[caption={Adaptação de métodos abstratos na linguagem \textit{Objective-C}}, label={lst:adaptacao}]
#pragma mark - Métodos Abstratos
//Chamado ao iniciar o efeito. Não implementar o método nativo init!
-(void)onInit{
    [NSException raise:NSInternalInconsistencyException format:@"Você deve sobescrever o método onInit na classe filha!"];
}
//Chamado ao aplicar as configurações no efeito
-(void)onConfigurationChanged{
    [NSException raise:NSInternalInconsistencyException format:@"Você deve sobescrever o método onConfigurationChanged na classe filha!"];
}
//Chamado ao receber novas amostras de áudio.
-(void)onStream : (UInt32) inNumberFrames sampleBufferLeft: (float*) sampleBufferLeft sampleBufferRight: (float*) sampleBufferRight{
    [NSException raise:NSInternalInconsistencyException format:@"Você deve sobescrever o método onStream na classe filha!"];
}
\end{lstlisting}

% -------------------------------------- SEÇÃO DESENVOLVIMENTO DE EFEITOS ------------------------------------------------

\section{Desenvolvimento dos Efeitos}
\label{sec:desenvolvimento}

Neste seção será demonstrado os detalhes no desenvolvimento dos efeitos: \textit{Distortion}, \textit{Overdrive}, \textit{Fuzz}, \textit{Tremolo}, \textit{Delay} e \textit{Pitch Shifter}. 

O primeiro passo para a criação de um efeito sonoro utilizando o iSoundFx é criar 
uma classe que implemente a interface \textit{IEffect}. Desta forma, o método \textit{onSample}
receberá por parâmetro as amostras de áudio dos canais esquerdo e direito e a 
quantidade dessas amostras. A taxa de amostragem foi quantizada em 16 bits e 
a 44.100Hz. Por padrão, as amostras são capturadas no tipo inteiro, mas, para facilitar as operações dos algoritmos realizou-se uma conversão para o tipo ponto flutuante com varições entre 0 e 1. 	

% -------------------------------------- DELAY ------------------------------------------------

\subsection{\textit{Delay}}

O efeito de Eco ou \textit{Delay} como explicado na seção \ref{sec:efeitos} pode ser brevemente 
descrito como a repetição do sinal original até o decaimento total do som. Uma
estrutura de dados que é utilizada para a construção deste efeito é a fila circular 
(Figura  \ref{fig:filacircular}). Ela funciona da seguinte forma: os dados são inseridos na fila e são 
removidos de acordo com a ordem de inserção. Para o caso do efeito de \textit{Delay} as 
amostras de áudio são inseridas na fila e conforme o  tempo pré-definido as 
amostras são executadas e removidas da fila. 

\begin{figure}[H]
\center
\fbox{\includegraphics[scale=0.7]{filacircular.png}}
\caption[Fila Circular]{Fila Circular \cite{pimentelcristina}}
\label{fig:filacircular}
\end{figure}

Os parâmetros de configuração do 
efeito são:

\begin{itemize}

\item \textit{Level} --- Expressa a intensidade das repetições. Os valores estão entre 0 e 0,5;
\item \textit{Feedback} --- É a quantidade de repetições. Os valores vão de 1 à 10;
\item \textit{Delay} --- É o tempo entre as repetições. Os valores estão entre 0 até 5 segundos.

\end{itemize}


Para o cálculo do decaimento do delay é necessário o uso das através das 
fórmulas:

\begin{equation}
S = (feedback + 1) * feedback /2
\end{equation}
\begin{equation}
levelFactor = level/S
\end{equation}

Sendo o \textit{levelFactor} a variável que será multiplicada pela posição da amostra 
de áudio na fila circular, para obter o level de cada repetição do sinal. No Algoritmo \ref{lst:delay}
pode ser observado esse procedimento no último laço do "for".

\begin{lstlisting}[caption={Código do efeito de \textit{Delay}}, label={lst:delay}]
    //Iteração entre as amostras de áudio
	for (int index = 0; index < inNumberFrames ; index++ ) {		
        bufferLeft[bufferHead] = sampleBufferLeft[index];
        bufferRight[bufferHead] = sampleBufferRight[index];        
        bufferHead++;        
		if(bufferHead >= BUFFER_LENGTH - 1){
            bufferHead = 0;
        }        
		sampleBufferRight[index] *=.5;
        sampleBufferLeft[index] *=.5;
	}		
		
    //Iteração da repetição do sinal
    for(int i = 1 , j = feedback ; i < feedback; i++, j--){        
        bufferTail = (bufferHead - (delay + inNumberFrames) * i);
        if(bufferTail < 0){
            bufferTail = (BUFFER_LENGTH - 1) - abs(bufferTail);
        }
			
        //Iteração para o cálculo da intensidade do sinal.			
        for (int index = 0; index < inNumberFrames ; index++ ) {                    
            //Level da repetição do sinal        
            sampleBufferLeft[index] += bufferLeft[bufferTail] * (level * j);
            sampleBufferRight[index] += bufferRight[bufferTail] * (level * j);                     
            bufferTail++;        
            if(bufferTail >= BUFFER_LENGTH - 1){
                bufferTail = 0;
            }
        }
    }
\end{lstlisting}

% -------------------------------------- OVERDRIVE ------------------------------------------------

\subsection{\textit{Overdrive}}  

O efeito de \textit{Overdrive} foi proveniente de \citeonline{chang}, o 
algoritmo foi adaptado para o funcionamento no iSoundFx a partir das fórmulas:

\begin{equation}
\label{eq:ganho}
K = \frac{2 * f_{ganho}}{1 - f_{ganho}}
\end{equation}
\begin{equation}
\label{eq:overdrive}
X = \frac{((1 + K) * X)}{1 + K * abs(X)} 
\end{equation}

Sendo que $f_{ganho}$ corresponde ao nível de distorção e $X$ a amostra de áudio. O Algoritmo \ref{lst:overdrive} expressa as fórmulas de distorção 
aplicadas. 

\begin{lstlisting}[caption={Código do efeito de \textit{Overdrive}}, label={lst:overdrive}]
(void)onStream : (UInt32) inNumberFrames sampleBufferLeft: (float*) sampleBufferLeft sampleBufferRight: (float*) sampleBufferRight{
    float *x1, *x2;
    x1 = sampleBufferLeft;
    x2 = sampleBufferRight;
    for(int i = 0; i < inNumberFrames; i++){    
        //Fórmula de ganho:
        x1[i] = ((1 + k) * x1[i]) / ( 1 + k * abs(x1[i]) );
        //Fórmula de intensidade:
        x1[i] = x1[i] * level;
        x2[i] = x1[i];
    }
}
\end{lstlisting}

Os parâmetros do efeito foram definidos como:

\begin{itemize}
\item \textit{Gain} --- Corresponde a quantidade saturada. Os valores variam de -1 à 1;
\item \textit{Level} --- É a intensidade do sinal. Os valores podem ser ajustados de 0 à 1.
\end{itemize}


% -------------------------------------- DISTORTION ------------------------------------------------
\subsection{\textit{Distortion}}  

A construção do efeito de \textit{Distortion} foi baseada no trabalho de \citeonline{krueger}. A equação \ref{eq:ganho} foi reutilizada, e a equação \ref{eq:overdrive} teve uma alteração:

\begin{equation}
X = \frac{((f_{ganho2} + K) * X)}{f_{ganho2} + K * abs(X)} 
\end{equation}

Sendo que $f_{ganho2}$ corresponde a segunda saturação. O algoritmo de funcionamento ficou semelhante ao algoritmo de \textit{Overdrive}, como pode ser visto no Algoritmo \ref{lst:distortion}.

\begin{lstlisting}[caption={Código do efeito de \textit{Distortion}}, label={lst:distortion}]
(void)onStream : (UInt32) inNumberFrames sampleBufferLeft: (float*) sampleBufferLeft sampleBufferRight: (float*) sampleBufferRight{
    float *x1, *x2;
    x1 = sampleBufferLeft;
    x2 = sampleBufferRight;
    for(int i = 0; i < inNumberFrames; i++){
		//Fórmula de ganho.
        x1[i] = ((boost + k) * x1[i]) / ( boost + k * abs(x1[i]) );
        //Fórmula de intensidade.
        x1[i] = x1[i] * level;
        x2[i] = x1[i];
    }
}
\end{lstlisting}

Os parâmetros do efeito foram definidos abaixo:

\begin{itemize}
\item \textit{Boost} --- É a saturação do sinal no primeiro nível. Os valores variam de -1 à 1;
\item \textit{Gain} --- É a saturação do sinal no segundo nível. Os valores podem ser ajustados de 0 à 1;
\item \textit{Level} --- É a intensidade do sinal. Os valores podem ser ajustados de 0 à 1.
\end{itemize}

% -------------------------------------- FUZZ ------------------------------------------------

\subsection{\textit{Fuzz}}  

O efeito de \textit{Fuzz}, foi originado de \citeonline{harlan}. Sua implementação foi mais simples que o efeito de \textit{Overdrive}: definiu-se o limiar de clipagem do sinal e depois o amplificou. As fórmulas utilizadas podem ser expressas pelas equações:

\[
X = \begin{cases} lim, & \mbox{se } X > lim \\ -lim, & \mbox{se } X < -lim \end{cases}
\]

\begin{equation}
X = X * ganho
\end{equation}

Sendo $lim$ o limiar de clipagem, $ganho$ o nível de saturação e $X$ o sinal. O Algoritmo \ref{lst:fuzz} demonstra a aplicação das fórmulas para obter o efeito.

\begin{lstlisting}[caption={Código do efeito de \textit{Fuzz}}, label={lst:fuzz}]
(void)onStream : (UInt32) inNumberFrames sampleBufferLeft: (float*) sampleBufferLeft sampleBufferRight: (float*) sampleBufferRight{
    float *x1, *x2;
    x1 = sampleBufferLeft;
    x2 = sampleBufferRight;
    for(int i = 0; i < inNumberFrames; i++){
        //Clipagem do sinal
        if(x1[i] > lim){
            x1[i] = lim;	
        }else if(x1[i] < -lim){
            x1[i] = -lim;
        }
		
		//Intensidade do sinal
        x1[i] = x1[i] * level;
        x2[i] = x1[i];
    }
}
\end{lstlisting}

Os parâmetros do efeito de \textit{Fuzz} são:

\begin{itemize}
\item \textit{Gain} --- Corresponde ao nível de clipagem. Os valores variam de 0 à 1;
\item \textit{Level} --- É a intensidade da distorção. Os valores podem ser ajustados de 0 à 1.
\end{itemize}

% -------------------------------------- TREMOLO ------------------------------------------------
\subsection{\textit{Tremolo}}

O efeito de \textit{Tremolo} foi derivado da aplicação \textit{SkypeFX}. Para a construção desse efeito foi utilizado um oscilador de baixa frequência cossenoidal. A fórmula simplificada que deu a origem ao efeito foi:

\begin{equation}
X = X * (\cos(pos) + 1) * amp
\end{equation}

Sendo que: $X$ corresponde ao sinal de entrada, $pos$ é a posição do oscilador e $amp$ a intensidade do oscilador. O código pode ser visto no Algoritmo \ref{lst:tremolo}.

\begin{lstlisting}[caption={Código do efeito de \textit{Tremolo}}, label={lst:tremolo}]
-(void) onStream:(UInt32)inNumberFrames sampleBufferLeft:(float *)sampleBufferLeft sampleBufferRight:(float *)sampleBufferRight{
   for (int index = 0; index < inNumberFrames ; index++ ) {       
       sampleBufferLeft[index] = sampleBufferLeft[index] * ((cos(pos) + 1) * sc + amount);
       sampleBufferRight[index] = sampleBufferRight[index] * ((cos(pos + sep) + 1) * sc + amount);
       pos += adv;      
	}
}
\end{lstlisting}

Os parâmetros do efeito são:

\begin{itemize}
\item \textit{Rate} --- É a frequência ou velocidade do oscilador. Os valores variam de 1 à 30;
\item \textit{Depth} --- É a intensidade do oscilador ou profundidade. A variação é entre 0 à 1;
\item \textit{Ping-Pong} --- Define o nível de separação do sinal entre os canais esquerdo e direito. Os valores são iguais ao \textit{Rate}.
\end{itemize}

% -------------------------------------- PITCH ------------------------------------------------
\subsection{\textit{Pitch}}

O efeito \textit{Pitch} foi retirado da aplicação \textit{audioGraph}. Não foi necessário realizar muitas adaptações para o funcionamento no iSoundFX, pois, o algoritmo original já trabalhava com sinais do tipo flutuante. 
Portanto essa seção não demonstrará o desenvolvimento do efeito. O parâmetro de configuração do efeito é apenas a mudança do tom do sinal, podendo ser mais grave ou mais agudo. 


% -------------------------------------- APLICAÇÃO DE EXEMPLO ------------------------------------------------

\section{Aplicação de Exemplo}
\label{sec:aplicacao}

Nesta seção será demonstrado o uso do iSoundFX através da construção de uma aplicação de exemplo. Será abordado também o processo de elaboração da interface desse programa.

A criação da aplicação foi elaborada em duas fases de desenvolvimento: na primeira etapa foram criados protótipos de tela que explorassem as funcionalidades da biblioteca; na segunda etapa as telas foram implementadas e os métodos de acesso do iSoundFX foram ligados as ações dos componentes de interface.
	
O processo de concepção dos protótipos de interface foi realizado através do recurso de \textit{Storyboard} presente no ambiente de desenvolvimento \textit{Xcode}. Dentre outras facilidades, este recurso permite que os componentes sejam arrastados na tela dispensando o uso de outros programas para este fim. 
	
Na tela principal da Figura \ref{fig:prototiposdetela} pode-se observar os elementos de interface: a barra superior comporta os botões de captura de áudio representado por (1). Do lado oposto, representado por (2), estão os botões de mover para esquerda da cadeia, adicionar um novo efeito, remover o efeito atual e mover para a direita da cadeia respectivamente.

\begin{figure}[H]
\center
\includegraphics[scale=0.55]{prototiposdetela.png}
\caption[Tela principal e tela do efeito de \textit{Delay}]{Tela principal (a esq.) e tela do efeito de \textit{Delay} (a dir.)}
\label{fig:prototiposdetela}
\end{figure}

A parte central da tela, representado por (3), é a área onde estarão dispostos os componentes de interface responsáveis por configurar os parâmetros dos efeitos. E, na barra inferior, representado por (4), é onde estarão as abas dos efeitos adicionados. As configurações dos efeitos serão apresentadas na região central da tela sempre que o usuário alternar entre as abas.

Na tela de \textit{Delay}, na mesma figura, estão: em (5) os componentes de interface responsáveis pelas configurações do efeito, para este fim optou-se por utilizar controles deslizantes; em (6) está o botão de estado, onde é possível ativar ou desativar o efeito; e em (7) a aba do efeito selecionado.

A partir das telas da Figura \ref{fig:prototiposdetela}, chegou-se ao resultado final ilustrado na Figura \ref{fig:telasdelayoverdrive}. Essa figura foi capturada da tela do \textit{iPod} enquanto a aplicação estava sendo executada. Observa-se que a aba selecionada está com um destaque no ícone com a cor azul. Nota-se também que o botão ativar/desativar efeito está desativado na tela de \textit{Delay} e ativado na tela de \textit{Overdrive}.

\begin{figure}[H]
\center
\includegraphics[scale=0.55]{telasdelayoverdrive.png}
\caption[Tela do efeito de \textit{Delay} e \textit{Overdrive}]{Tela do efeito de \textit{Delay} e \textit{Overdrive} (da esq. para a dir.)}
\label{fig:telasdelayoverdrive}
\end{figure}

A próxima etapa do desenvolvimento da aplicação foi instanciar a biblioteca iSoundFX e relacioná-la às ações dos componentes de interface. O método \textit{viewDidLoad} da classe principal da aplicação instancia o \textit{ISoundFX} uma única vez e sua referência é passada para a classe \textit{MainAppDelegate}, para que o acesso a biblioteca seja compartilhado através do padrão \textit{Singleton}. Essa operação pode ser vista no código do Algoritmo \ref{lst:compartilhamento}.

\begin{lstlisting}[caption={Compartilhamento da classe \textit{ISoundFX}}, label={lst:compartilhamento}]
- (void)viewDidLoad
{
    [super viewDidLoad];   
    //Criação da classe
    iSoundFx = [[ISoundFx alloc] init];    
    //Obtenção da referência da classe MainAppDelegate
    MainAppDelegate *appDelegate =(MainAppDelegate *)[[UIApplication sharedApplication] delegate];      
    //Compartilhamento da instância
    appDelegate.iSoundFx = iSoundFx;   
}
\end{lstlisting}

Para vincular controles de interface à biblioteca foram definidos três tipos de métodos: \textit{initControls} --- reponsável por iniciar os elementos de interface; \textit
{effectEnabled} --- responsável por ativar e desativar o efeito; \textit{effectChanged} --- reponsável por alterar o valor do efeito. O código do Algoritmo \ref{lst:configuracao} exemplifica a utilização dos métodos para o efeito de \textit{Pitch}.

\begin{lstlisting}[caption={Métodos de configuração do efeito de \textit{Pitch}.}, label={lst:configuracao}]
-(void)initControls{
    [pitchShift setMaximumValue: [iSoundFx getEffectMaxValue:self.indexInParent sliderIndex:PITCH_SHIFT]];
    [pitchShift setMinimumValue:[iSoundFx getEffectMinValue:self.indexInParent sliderIndex:PITCH_SHIFT]]; 
    [pitchShift setValue: [iSoundFx getEffectValue:self.indexInParent sliderIndex:PITCH_SHIFT]];    
    [pitchSwitch setOn:[iSoundFx isEffectEnabled:self.indexInParent] ];
}

- (IBAction)effectEnabled:(id)sender {
    UISwitch *switchBtn = (UISwitch*)sender;
    [iSoundFx enableEffect:switchBtn.isOn effectIndex:self.indexInParent];    
}

- (IBAction)effectChanged:(id)sender {
    UISlider *slider = (UISlider*)sender;    
    [iSoundFx changeEffect: slider.value effectIndex:self.indexInParent sliderIndex:PITCH_SHIFT];
}
\end{lstlisting}

% -------------------------------------- SEÇÃO RESULTADOS ------------------------------------------------

\section{Resultados}

Nessa seção serão apresentados os resultados obtidos a partir de testes realizados com a aplicação de exemplo da biblioteca iSoundFX. O intuito desses testes é fazer uma análise visual dos efeitos produzidos pela biblioteca através dos espectros dos sinais de áudio. 

Para aplicar os testes foi utilizado um programa chamado \textit{Audacity}, através desta ferramenta foi possível visualizar os espectros de áudio no domínio do tempo e no domínio da frequência. Os materiais utilizados para os testes foram:

\begin{itemize}
\item Guitarra \textit{Vintage} Modelo \textit{Stratocaster};
\item \textit{iPod Touch} 4G versão 5.1.1;
\item Conector \textit{iRig};
\item Computador com \textit{Windows} 7 com o programa \textit{Audacity} versão 1.3 instalado.
\end{itemize}

A Figura \ref{fig:testeisoundfx} exemplifica o esquema de funcionamento dos testes. A guitarra é conectada ao \textit{iPod} pela interface \textit{iRig}, que por sua vez tem sua saída conectada a entrada de microfone do computador. A biblioteca foi alterada para que o canal de áudio esquerdo não realizasse modificações no sinal, enquanto que no canal direito, os efeitos foram aplicados. Dessa forma, os espectros poderam ser comparados a um mesmo sinal de entrada.

Os espectros dos sinais foram capturados pelo \textit{Audacity} ao tempo que se tocava acordes e notas na guitarra. A disposição das imagens obtidas estão na seguinte forma: o eixo horizontal representa o tempo, em segundos, e o eixo vertical a amplitude, na escala de 0 à 1. A imagem superior corresponde ao sinal antes do efeito e a imagem inferior o sinal com o efeito aplicado. 

Na Figura \ref{fig:audacitydelay} é possível observar os resultados do teste realizado com o efeito de \textit{Delay}. Os parâmetros foram ajustados em três repetições, 0.1 segundos de \textit{delay} e 0.8 de \textit{level}. Pela análise do espectro do sinal pode-se constatar que o efeito obteve êxito, já que a intensidade do sinal vai decaindo em cada repetição do sinal, caracterizando o efeito de \textit{Delay} \cite{mendesGoulart}.

\begin{figure}[H]
\center
\fbox{\includegraphics[scale=0.6]{testeisoundfx.png}}
\caption{Esquema de teste do iSoundFX}
\label{fig:testeisoundfx}
\end{figure}

\begin{figure}[H]
\center
\includegraphics[scale=0.5]{audacitydelay.png}
\caption{Sinal original e com efeito de \textit{Delay}}
\label{fig:audacitydelay}
\end{figure}

Os resultados do teste com o efeito de \textit{Overdrive} podem ser vistos na Figura \ref{fig:audacityoverdrive}. Os parâmetros foram ajustados em 0.8 de \textit{gain} e 0.6 de \textit{level}.  Pelo sinal obtido é possível afirmar que o efeito em questão está cumprindo as características da sua definição: o sinal está amplificado e saturado em alguns pontos \cite{mendesGoulart}. Devido a similaridade entre os sinais dos efeitos de \textit{Overdrive}, \textit{Fuzz} e Distorção, não foram realizados testes nos dois últimos efeitos.

\begin{figure}[H]
\center
\includegraphics[scale=0.55]{audacityoverdrive.png}
\caption{Sinal original e com efeito de \textit{Overdrive}}
\label{fig:audacityoverdrive}
\end{figure}

A Figura \ref{fig:audacitytremolo} demonstra os resultados do teste com o efeito de \textit{Tremolo}. Os parâmetros foram ajustados em 0.5 de \textit{depth}, 10Hz de \textit{rate} e 0 de \textit{ping-pong}. O efeito em análise cumpriu com as expectativas: o sinal foi atenuado periodicamente.

\begin{figure}[H]
\center
\includegraphics[scale=0.55]{audacitytremolo.png}
\caption{Sinal original e com efeito de \textit{Tremolo}}
\label{fig:audacitytremolo}
\end{figure}

A diferença entre os sinais obtidos no teste do efeito de \textit{Pitch} não foi evidente quando a análise foi realizada no domínio do tempo (amplitude X tempo), por isso utilizou-se um recurso do \textit{Audacity} que demonstra, através do processo de FFT, os sinais no domínio da frequência. Nesta forma de representação do espectro do sinal está sob forma de frequência, em Hz, por amplitude, em dB. A imagem a esquerda corresponde ao sinal original e a direita o sinal após o efeito.

Na Figura \ref{fig:audacitypitch} demonstra os resultados do teste com o efeito de \textit{Pitch}. O parâmetro \textit{level} foi ajustado em 1.0. Observa-se, ao analisar os espectros, que o sinal original possui um pico acima de -21dB na frequência de 300Hz, enquanto que o sinal com o efeito aplicado, possui um pico também acima de -21dB na frequência de 600Hz. Isso quer dizer que o efeito obteve sucesso.

\begin{figure}[H]
\center
\includegraphics[scale=0.45]{audacitypitch.png}
\caption{Sinal original e com efeito de \textit{Pitch}}
\label{fig:audacitypitch}
\end{figure}

A análise visual dos espectros de sinais de áudio constataram que o funcionamento dos efeitos desenvolvidos cumpriram com o esperado. Pode-se afirmar que, auditivamente, o resultado sonoro produzido pelos efeitos do iSoundFX tiveram uma qualidade satisfatória quando comparados com as aplicações \textit{GarageBand} e \textit{Amplitube}.